<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON TYPE: EVOLUTION 2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --neon-yellow: #ffea00;
            --bg-dark: #0a0a12;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'JetBrains Mono', 'Noto Sans JP', monospace;
            overflow: hidden;
            user-select: none;
        }

        /* Scanline effect */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.3;
        }

        .glow-text { text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue); }
        .glow-pink { text-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink); }
        .glow-green { text-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green); }

        .word-container {
            position: absolute;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 1.5rem;
            font-weight: bold;
            transition: top 0.1s linear, font-size 0.3s ease;
            text-align: center;
        }

        .char-correct { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); }
        .char-current { 
            color: var(--neon-pink); 
            text-decoration: underline; 
            background-color: rgba(255, 0, 255, 0.2);
            border-radius: 2px;
        }
        .char-pending { color: rgba(255, 255, 255, 0.5); }

        .game-ui {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .btn-icon {
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            color: var(--neon-blue);
            transform: scale(1.1);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* Particle animations */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0); opacity: 0; }
        }
        .particle {
            position: absolute;
            width: 4px; height: 4px;
            background: var(--neon-blue);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp 0.5s ease-out forwards;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        .shake { animation: shake 0.4s; }

        .fever-mode .word-container {
            text-shadow: 0 0 5px var(--neon-pink);
        }
        
        /* Modal Overlay */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }

        /* Keyboard hint */
        .key {
            width: 28px; height: 28px;
            border: 1px solid #444;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #666;
            transition: all 0.05s;
        }
        .key.active {
            border-color: var(--neon-blue);
            color: white;
            background: rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 10px var(--neon-blue);
            transform: scale(0.95);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center">

    <div class="scanlines"></div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="absolute z-40 flex flex-col items-center justify-center w-full h-full bg-black/90 transition-opacity duration-500">
        <h1 class="text-6xl md:text-8xl font-bold glow-text mb-2 tracking-tighter">NEON TYPE</h1>
        <p class="text-xl text-cyan-300 mb-12 tracking-widest opacity-80">EVOLUTION 2.1</p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl px-8">
            <button onclick="game.start('evolution')" class="group relative p-6 border border-cyan-500 hover:bg-cyan-500/20 transition-all duration-300 rounded-lg overflow-hidden text-left">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-cyan-500/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                <h3 class="text-2xl font-bold text-cyan-400 mb-2 group-hover:scale-105 transition-transform"><i class="fas fa-rocket mr-2"></i>EVOLUTION</h3>
                <p class="text-sm text-gray-400">適応型無限モード。<br>実力に合わせて速度が変化。</p>
            </button>
            
            <button onclick="game.start('blitz')" class="group relative p-6 border border-pink-500 hover:bg-pink-500/20 transition-all duration-300 rounded-lg text-left">
                 <div class="absolute inset-0 bg-gradient-to-r from-transparent via-pink-500/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                <h3 class="text-2xl font-bold text-pink-400 mb-2 group-hover:scale-105 transition-transform"><i class="fas fa-stopwatch mr-2"></i>BLITZ 60s</h3>
                <p class="text-sm text-gray-400">60秒のタイムアタック。<br>ハイスコアを目指せ。</p>
            </button>
            
            <button onclick="game.start('zen')" class="group relative p-6 border border-green-500 hover:bg-green-500/20 transition-all duration-300 rounded-lg text-left">
                 <div class="absolute inset-0 bg-gradient-to-r from-transparent via-green-500/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                <h3 class="text-2xl font-bold text-green-400 mb-2 group-hover:scale-105 transition-transform"><i class="fas fa-leaf mr-2"></i>ZEN</h3>
                <p class="text-sm text-gray-400">ゲームオーバーなし。<br>リラックスして練習。</p>
            </button>
        </div>

        <div class="mt-12 text-gray-500 text-xs text-center space-y-1">
            <p>ESCキーで一時停止</p>
        </div>
    </div>

    <!-- PAUSE MENU -->
    <div id="pause-menu" class="hidden absolute z-50 flex flex-col items-center justify-center w-full h-full modal-overlay">
        <h2 class="text-5xl font-bold text-white mb-8 tracking-widest glow-text">PAUSED</h2>
        <div class="flex flex-col gap-4 w-64">
            <button onclick="game.resume()" class="px-6 py-3 border border-cyan-400 text-cyan-400 hover:bg-cyan-400 hover:text-black font-bold transition-all rounded">RESUME</button>
            <button onclick="game.restart()" class="px-6 py-3 border border-white text-white hover:bg-white hover:text-black font-bold transition-all rounded">RESTART</button>
            <button onclick="game.quit()" class="px-6 py-3 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white font-bold transition-all rounded">EXIT TO TITLE</button>
        </div>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="game-over" class="hidden absolute z-50 flex flex-col items-center justify-center w-full h-full bg-black/95">
        <h2 class="text-5xl font-bold text-white mb-2">RESULT</h2>
        <div class="text-6xl font-bold glow-pink mb-2" id="final-score">0</div>
        <p class="text-sm text-gray-400 mb-8">FINAL SCORE</p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center mb-10 w-full max-w-4xl px-4">
            <div class="p-4 border border-gray-800 rounded bg-gray-900/50">
                <p class="text-gray-500 text-xs tracking-widest mb-1">SPEED</p>
                <p id="final-wpm" class="text-3xl text-cyan-400 font-bold">0</p>
                <p class="text-[10px] text-gray-600">WPM</p>
            </div>
            <div class="p-4 border border-gray-800 rounded bg-gray-900/50">
                <p class="text-gray-500 text-xs tracking-widest mb-1">ACCURACY</p>
                <p id="final-acc" class="text-3xl text-green-400 font-bold">0%</p>
                <p class="text-[10px] text-gray-600">MISS: <span id="final-miss">0</span></p>
            </div>
            <div class="p-4 border border-gray-800 rounded bg-gray-900/50">
                <p class="text-gray-500 text-xs tracking-widest mb-1">MAX COMBO</p>
                <p id="final-combo" class="text-3xl text-purple-400 font-bold">0</p>
            </div>
             <div class="p-4 border border-gray-800 rounded bg-gray-900/50">
                <p class="text-gray-500 text-xs tracking-widest mb-1">RANK</p>
                <p id="final-rank" class="text-3xl text-yellow-400 font-bold">-</p>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="game.restart()" class="px-8 py-3 bg-cyan-500 text-black font-bold text-lg hover:bg-cyan-400 hover:scale-105 transition-all rounded shadow-[0_0_20px_rgba(6,182,212,0.5)]">
                RETRY
            </button>
            <button onclick="game.quit()" class="px-8 py-3 border border-gray-600 text-gray-400 font-bold text-lg hover:border-white hover:text-white transition-all rounded">
                HOME
            </button>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud" class="hidden absolute top-0 w-full p-4 flex justify-between items-start z-30 pointer-events-none">
        <!-- Top Left: Menu Controls -->
        <div class="game-ui p-2 rounded flex flex-col gap-2 pointer-events-auto">
            <button onclick="game.togglePause()" class="btn-icon text-gray-400 hover:text-white" title="Pause (ESC)">
                <i class="fas fa-pause"></i>
            </button>
            <button onclick="game.quit()" class="btn-icon text-gray-400 hover:text-white" title="Home">
                <i class="fas fa-home"></i>
            </button>
        </div>

        <!-- Center: Fever & Score -->
        <div class="absolute left-1/2 transform -translate-x-1/2 top-4 flex flex-col items-center">
             <div class="game-ui px-8 py-2 rounded-full mb-2">
                <span class="text-xs text-gray-400 mr-2">SCORE</span>
                <span id="score" class="text-2xl font-bold text-white">0</span>
            </div>
            <div id="fever-indicator" class="opacity-0 transition-opacity text-center">
                <p class="text-pink-500 font-bold italic tracking-widest text-lg glow-pink">FEVER MODE</p>
                <div class="w-full h-1 bg-pink-900 rounded-full mt-1 overflow-hidden">
                    <div id="fever-bar" class="h-full bg-pink-500 w-full"></div>
                </div>
            </div>
        </div>

        <!-- Top Right: Stats -->
        <div class="game-ui p-4 rounded-bl-2xl text-right pointer-events-auto min-w-[150px]">
            <div class="flex justify-between items-end mb-1">
                <div id="mode-indicator" class="text-[10px] text-pink-500 font-bold tracking-widest">MODE</div>
                <div id="level-display" class="text-xs font-bold text-cyan-400">LV.1</div>
            </div>
            
            <div id="health-bar-container" class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden mb-2">
                <div id="health-bar" class="h-full bg-green-500 w-full transition-all duration-300"></div>
            </div>
            <div id="timer-display" class="hidden text-3xl font-bold text-white font-mono mb-1">60.0</div>
            
            <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span>COMBO: <span id="combo" class="text-yellow-400 font-bold text-lg">0</span></span>
                <span>WPM: <span id="wpm" class="text-white font-bold">0</span></span>
            </div>
        </div>
    </div>

    <!-- GAME AREA -->
    <div id="game-area" class="relative w-full h-full overflow-hidden">
        <!-- Words will be spawned here -->
    </div>

    <!-- VIRTUAL KEYBOARD VISUALIZER (Bottom) -->
    <div id="keyboard-viz" class="absolute bottom-4 z-20 flex flex-col items-center gap-1 opacity-30 transition-opacity duration-300">
        <div class="flex gap-1">
            <div class="key" id="key-q">Q</div><div class="key" id="key-w">W</div><div class="key" id="key-e">E</div><div class="key" id="key-r">R</div><div class="key" id="key-t">T</div><div class="key" id="key-y">Y</div><div class="key" id="key-u">U</div><div class="key" id="key-i">I</div><div class="key" id="key-o">O</div><div class="key" id="key-p">P</div>
        </div>
        <div class="flex gap-1 pl-4">
            <div class="key" id="key-a">A</div><div class="key" id="key-s">S</div><div class="key" id="key-d">D</div><div class="key" id="key-f">F</div><div class="key" id="key-g">G</div><div class="key" id="key-h">H</div><div class="key" id="key-j">J</div><div class="key" id="key-k">K</div><div class="key" id="key-l">L</div>
        </div>
        <div class="flex gap-1 pl-8">
            <div class="key" id="key-z">Z</div><div class="key" id="key-x">X</div><div class="key" id="key-c">C</div><div class="key" id="key-v">V</div><div class="key" id="key-b">B</div><div class="key" id="key-n">N</div><div class="key" id="key-m">M</div>
        </div>
    </div>

    <script>
        // --- GAME DATA ---
        // ka (Hiragana) field retained for future use, but logic now uses 'en' strictly
        const WORD_DATA = [
            // EASY (1-3 chars, simple)
            {ja: "猫", ka: "ねこ", en: "neko"}, {ja: "犬", ka: "いぬ", en: "inu"}, {ja: "空", ka: "そら", en: "sora"},
            {ja: "海", ka: "うみ", en: "umi"}, {ja: "夏", ka: "なつ", en: "natsu"}, {ja: "冬", ka: "ふゆ", en: "fuyu"},
            {ja: "月", ka: "つき", en: "tsuki"}, {ja: "本", ka: "ほん", en: "hon"}, {ja: "赤", ka: "あか", en: "aka"},
            {ja: "青", ka: "あお", en: "ao"}, {ja: "白", ka: "しろ", en: "shiro"}, {ja: "黒", ka: "くろ", en: "kuro"},
            {ja: "雨", ka: "あめ", en: "ame"}, {ja: "雪", ka: "ゆき", en: "yuki"}, {ja: "雲", ka: "くも", en: "kumo"},
            {ja: "風", ka: "かぜ", en: "kaze"}, {ja: "花", ka: "はな", en: "hana"}, {ja: "鳥", ka: "とり", en: "tori"},
            {ja: "山", ka: "やま", en: "yama"}, {ja: "川", ka: "かわ", en: "kawa"}, {ja: "道", ka: "みち", en: "michi"},
            {ja: "駅", ka: "えき", en: "eki"}, {ja: "車", ka: "くるま", en: "kuruma"}, {ja: "夢", ka: "ゆめ", en: "yume"},
            {ja: "愛", ka: "あい", en: "ai"}, {ja: "友", ka: "とも", en: "tomo"}, {ja: "心", ka: "こころ", en: "kokoro"},
            
            // MEDIUM (4-6 chars, compounds)
            {ja: "未来", ka: "みらい", en: "mirai"}, {ja: "世界", ka: "せかい", en: "sekai"}, {ja: "平和", ka: "へいわ", en: "heiwa"},
            {ja: "自由", ka: "じゆう", en: "jiyuu"}, {ja: "希望", ka: "きぼう", en: "kibou"}, {ja: "勇気", ka: "ゆうき", en: "yuuki"},
            {ja: "冒険", ka: "ぼうけん", en: "bouken"}, {ja: "魔法", ka: "まほう", en: "mahou"}, {ja: "科学", ka: "かがく", en: "kagaku"},
            {ja: "技術", ka: "ぎじゅつ", en: "gijutsu"}, {ja: "宇宙", ka: "うちゅう", en: "uchuu"}, {ja: "地球", ka: "ちきゅう", en: "chikyuu"},
            {ja: "自然", ka: "しぜん", en: "shizen"}, {ja: "社会", ka: "しゃかい", en: "shakai"}, {ja: "歴史", ka: "れきし", en: "rekishi"},
            {ja: "文化", ka: "ぶんか", en: "bunka"}, {ja: "芸術", ka: "げいじゅつ", en: "geijutsu"}, {ja: "音楽", ka: "おんがく", en: "ongaku"},
            {ja: "映画", ka: "えいが", en: "eiga"}, {ja: "料理", ka: "りょうり", en: "ryouri"}, {ja: "旅行", ka: "りょこう", en: "ryokou"},
            {ja: "写真", ka: "しゃしん", en: "shashin"}, {ja: "勉強", ka: "べんきょう", en: "benkyou"}, {ja: "仕事", ka: "しごと", en: "shigoto"},

            // HARD (Longer, complex sounds)
            {ja: "人工知能", ka: "じんこうちのう", en: "jinkouchinou"}, {ja: "仮想現実", ka: "かそうげんじつ", en: "kasougenjitsu"},
            {ja: "環境問題", ka: "かんきょうもんだい", en: "kankyoumondai"}, {ja: "一生懸命", ka: "いっしょうけんめい", en: "isshoukenmei"},
            {ja: "危機一髪", ka: "ききいっぱつ", en: "kikiippatsu"}, {ja: "自動販売機", ka: "じどうはんばいき", en: "jidouhanbaiki"},
            {ja: "新幹線", ka: "しんかんせん", en: "shinkansen"}, {ja: "図書館", ka: "としょかん", en: "toshokan"},
            {ja: "飛行機", ka: "ひこうき", en: "hikouki"}, {ja: "水族館", ka: "すいぞくかん", en: "suizokukan"},
            {ja: "博物館", ka: "はくぶつかん", en: "hakubutsukan"}, {ja: "遊園地", ka: "ゆうえんち", en: "yuuenchi"},
            {ja: "春夏秋冬", ka: "しゅんかしゅうとう", en: "shunkashuutou"}, {ja: "焼肉定食", ka: "やきにくていしょく", en: "yakinikuteishoku"},
            {ja: "精神統一", ka: "せいしんとういつ", en: "seishintouitsu"}, {ja: "前代未聞", ka: "ぜんだいみもん", en: "zendaimimon"}
        ];

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const Sound = {
            play(type) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                const now = audioCtx.currentTime;

                if (type === 'type') {
                    // Click sound
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800 + Math.random()*200, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                } else if (type === 'error') {
                    // Buzz
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                } else if (type === 'clear') {
                    // High ping
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                } else if (type === 'gameover') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1);
                    osc.start(now);
                    osc.stop(now + 1);
                }
            }
        };

        // --- GAME LOGIC ---
        const game = {
            state: {
                isPlaying: false,
                isPaused: false,
                mode: 'evolution',
                score: 0,
                combo: 0,
                maxCombo: 0,
                level: 1,
                health: 100,
                startTime: 0,
                lastSpawnTime: 0,
                spawnInterval: 2000,
                baseFallSpeed: 1.0, 
                wordsTyped: 0,
                keystrokes: 0,
                mistakes: 0,
                activeWords: [],
                feverMode: false,
                feverTimer: 0
            },
            
            dom: {
                menu: document.getElementById('main-menu'),
                hud: document.getElementById('hud'),
                gameArea: document.getElementById('game-area'),
                gameOver: document.getElementById('game-over'),
                pauseMenu: document.getElementById('pause-menu'),
                score: document.getElementById('score'),
                combo: document.getElementById('combo'),
                level: document.getElementById('level-display'),
                healthBar: document.getElementById('health-bar'),
                timer: document.getElementById('timer-display'),
                wpm: document.getElementById('wpm'),
                fever: document.getElementById('fever-indicator')
            },

            start(mode) {
                this.state.mode = mode;
                this.state.isPlaying = true;
                this.state.isPaused = false;
                this.state.score = 0;
                this.state.combo = 0;
                this.state.maxCombo = 0;
                this.state.level = 1;
                this.state.health = 100;
                this.state.wordsTyped = 0;
                this.state.keystrokes = 0;
                this.state.mistakes = 0;
                this.state.activeWords = [];
                this.state.startTime = Date.now();
                this.state.spawnInterval = mode === 'zen' ? 2000 : 2500;
                this.state.baseFallSpeed = mode === 'zen' ? 1.0 : 1.2;
                this.state.feverMode = false;

                this.dom.gameArea.innerHTML = '';
                this.dom.menu.classList.add('opacity-0', 'pointer-events-none');
                this.dom.hud.classList.remove('hidden');
                this.dom.gameOver.classList.add('hidden');
                this.dom.pauseMenu.classList.add('hidden');
                document.getElementById('mode-indicator').innerText = mode.toUpperCase();

                if (mode === 'blitz') {
                    this.dom.timer.classList.remove('hidden');
                    document.getElementById('health-bar-container').classList.add('hidden');
                } else {
                    this.dom.timer.classList.add('hidden');
                    document.getElementById('health-bar-container').classList.remove('hidden');
                }

                this.updateHUD();
                this.loopId = requestAnimationFrame((t) => this.loop(t));
                this.spawnWord();
            },

            togglePause() {
                if (!this.state.isPlaying) return;
                this.state.isPaused = !this.state.isPaused;
                if (this.state.isPaused) {
                    this.dom.pauseMenu.classList.remove('hidden');
                    cancelAnimationFrame(this.loopId);
                } else {
                    this.dom.pauseMenu.classList.add('hidden');
                    this.state.lastSpawnTime = Date.now(); 
                    this.loopId = requestAnimationFrame((t) => this.loop(t));
                }
            },

            resume() {
                this.togglePause();
            },

            restart() {
                this.start(this.state.mode);
            },

            quit() {
                this.state.isPlaying = false;
                cancelAnimationFrame(this.loopId);
                this.dom.gameArea.innerHTML = '';
                this.dom.hud.classList.add('hidden');
                this.dom.pauseMenu.classList.add('hidden');
                this.dom.gameOver.classList.add('hidden');
                this.dom.menu.classList.remove('opacity-0', 'pointer-events-none');
            },

            spawnWord() {
                if (!this.state.isPlaying || this.state.isPaused) return;

                // Pick word based on level
                let pool = [];
                if (this.state.level <= 3) pool = WORD_DATA.filter(w => w.ka.length <= 3);
                else if (this.state.level <= 6) pool = WORD_DATA.filter(w => w.ka.length <= 6);
                else pool = WORD_DATA;
                
                if (pool.length === 0) pool = WORD_DATA;

                const wordData = pool[Math.floor(Math.random() * pool.length)];

                // Prevent immediate duplicate
                if (this.state.activeWords.some(w => w.data.en === wordData.en)) {
                    const retry = pool[Math.floor(Math.random() * pool.length)];
                    if (!this.state.activeWords.some(w => w.data.en === retry.en)) {
                        // use retry
                    }
                }

                const el = document.createElement('div');
                el.className = 'word-container';
                
                // --- Simple HTML Structure (No Parser) ---
                el.innerHTML = `
                    <div class="text-xs text-cyan-300 opacity-80">${wordData.ja}</div>
                    <div class="tracking-widest font-mono">
                        <span class="char-pending">${wordData.en}</span>
                    </div>
                `;

                const x = 10 + Math.random() * 80;
                el.style.left = `${x}%`;
                el.style.top = '-60px';

                this.dom.gameArea.appendChild(el);

                this.state.activeWords.push({
                    element: el,
                    data: wordData,
                    typedIndex: 0, // Track progress simply by index
                    x: x,
                    y: -60,
                    speed: this.state.baseFallSpeed * (0.9 + Math.random() * 0.2)
                });
            },

            calculateStats() {
                const now = Date.now();
                const minutes = (now - this.state.startTime) / 60000;
                const wpm = minutes > 0 ? Math.floor(this.state.wordsTyped / minutes) : 0;
                return wpm;
            },

            adaptDifficulty(wpm) {
                if (this.state.mode !== 'evolution') return;

                const targetWPM = this.state.level * 8; 
                
                if (wpm > targetWPM && this.state.wordsTyped > this.state.level * 5) {
                    this.state.level++;
                    this.state.baseFallSpeed += 0.2; 
                    this.state.spawnInterval = Math.max(800, 2000 - (this.state.level * 100));
                    this.showFloatingText("SPEED UP!", "text-yellow-400");
                }
            },

            showFloatingText(text, colorClass) {
                const msg = document.createElement('div');
                msg.innerText = text;
                msg.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold ${colorClass} z-50 animate-bounce`;
                this.dom.gameArea.appendChild(msg);
                setTimeout(() => msg.remove(), 1000);
            },

            loop(timestamp) {
                if (!this.state.isPlaying || this.state.isPaused) return;

                const now = Date.now();
                const wpm = this.calculateStats();

                if (Math.floor(timestamp / 1000) > Math.floor(this.state.lastSpawnTime / 1000)) {
                   this.adaptDifficulty(wpm);
                }

                if (timestamp - this.state.lastSpawnTime > this.state.spawnInterval) {
                    this.spawnWord();
                    this.state.lastSpawnTime = timestamp;
                }

                if (this.state.mode === 'blitz') {
                    const remaining = 60 - ((now - this.state.startTime) / 1000);
                    this.dom.timer.innerText = remaining.toFixed(1);
                    if (remaining <= 0) {
                        this.endGame();
                        return;
                    }
                }

                const maxY = window.innerHeight;
                this.state.activeWords.forEach((wordObj, index) => {
                    wordObj.y += wordObj.speed;
                    wordObj.element.style.top = `${wordObj.y}px`;

                    if (wordObj.y > maxY - 100) {
                        this.state.activeWords.splice(index, 1);
                        wordObj.element.remove();
                        if (this.state.mode !== 'zen') {
                            this.damage();
                        }
                    }
                });

                this.updateHUD();
                this.loopId = requestAnimationFrame((t) => this.loop(t));
            },

            damage() {
                this.state.health -= 15;
                this.state.combo = 0;
                this.state.feverMode = false;
                this.dom.fever.classList.remove('opacity-100');
                document.body.classList.remove('fever-mode');
                Sound.play('error');
                this.dom.gameArea.classList.add('shake');
                setTimeout(() => this.dom.gameArea.classList.remove('shake'), 400);

                if (this.state.health <= 0) this.endGame();
            },

            handleInput(key) {
                if (!this.state.isPlaying || this.state.isPaused) return;

                this.state.keystrokes++;
                
                const keyEl = document.getElementById(`key-${key}`);
                if (keyEl) {
                    keyEl.classList.add('active');
                    setTimeout(() => keyEl.classList.remove('active'), 150);
                }

                // --- STRICT INPUT LOGIC ---
                // 1. Priority: Check if we are already typing a word (locked on)
                let target = this.state.activeWords.find(w => w.typedIndex > 0);
                
                if (target) {
                    // Check if key matches next char
                    if (target.data.en[target.typedIndex] === key) {
                        // Hit on locked word
                        this.processHit(target);
                    } else {
                        // Wrong key for locked word
                        this.miss();
                    }
                } else {
                    // 2. No word locked. Find words starting with key.
                    // Priority: Lowest word (highest Y)
                    const candidates = this.state.activeWords
                        .filter(w => w.data.en[0] === key)
                        .sort((a, b) => b.y - a.y);
                    
                    if (candidates.length > 0) {
                        // Hit on new word
                        this.processHit(candidates[0]);
                    } else {
                        // No match
                        this.miss();
                    }
                }
            },

            processHit(target) {
                Sound.play('type');
                target.typedIndex++;
                
                // --- Simple HTML Update ---
                const en = target.data.en;
                const typed = en.substring(0, target.typedIndex);
                const current = target.typedIndex < en.length ? en[target.typedIndex] : '';
                const pending = target.typedIndex + 1 < en.length ? en.substring(target.typedIndex + 1) : '';

                target.element.innerHTML = `
                    <div class="text-xs text-cyan-300 opacity-80">${target.data.ja}</div>
                    <div class="tracking-widest font-mono">
                        <span class="char-correct">${typed}</span><span class="char-current">${current}</span><span class="char-pending">${pending}</span>
                    </div>
                `;

                const rect = target.element.getBoundingClientRect();
                this.createParticle(rect.left + rect.width/2, rect.top + 20);

                if (target.typedIndex === en.length) {
                    this.wordComplete(target);
                }
            },

            miss() {
                Sound.play('error');
                this.state.mistakes++;
                this.state.combo = 0;
                this.state.feverMode = false;
                this.dom.fever.classList.remove('opacity-100');
                document.body.classList.remove('fever-mode');
            },

            wordComplete(wordObj) {
                Sound.play('clear');
                this.state.wordsTyped++;
                this.state.combo++;
                if (this.state.combo > this.state.maxCombo) this.state.maxCombo = this.state.combo;

                this.state.score += 100 * (1 + this.state.combo * 0.1) * (this.state.feverMode ? 2 : 1);
                
                if (this.state.mode === 'evolution') {
                    this.state.health = Math.min(100, this.state.health + 2);
                }

                const idx = this.state.activeWords.indexOf(wordObj);
                if (idx > -1) this.state.activeWords.splice(idx, 1);
                wordObj.element.remove();

                if (this.state.combo > 0 && this.state.combo % 10 === 0) {
                    this.activateFever();
                }
            },

            activateFever() {
                this.state.feverMode = true;
                this.dom.fever.classList.add('opacity-100');
                document.body.classList.add('fever-mode');
                clearTimeout(this.feverTimeout);
                this.feverTimeout = setTimeout(() => {
                    this.state.feverMode = false;
                    this.dom.fever.classList.remove('opacity-100');
                    document.body.classList.remove('fever-mode');
                }, 5000);
            },

            createParticle(x, y) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                this.dom.gameArea.appendChild(p);
                setTimeout(() => p.remove(), 500);
            },

            updateHUD() {
                this.dom.score.innerText = Math.floor(this.state.score);
                this.dom.combo.innerText = this.state.combo;
                this.dom.level.innerText = `LV.${this.state.level}`;
                this.dom.wpm.innerText = this.calculateStats();
                
                const p = this.state.health;
                this.dom.healthBar.style.width = `${p}%`;
                this.dom.healthBar.className = `h-full w-full transition-all duration-300 ${p < 30 ? 'bg-red-500' : p < 60 ? 'bg-yellow-500' : 'bg-green-500'}`;
            },

            endGame() {
                this.state.isPlaying = false;
                cancelAnimationFrame(this.loopId);
                Sound.play('gameover');
                
                this.dom.hud.classList.add('hidden');
                this.dom.gameOver.classList.remove('hidden');

                const wpm = this.calculateStats();
                const acc = this.state.keystrokes > 0 
                    ? Math.floor(((this.state.keystrokes - this.state.mistakes) / this.state.keystrokes) * 100) 
                    : 0;

                document.getElementById('final-score').innerText = Math.floor(this.state.score);
                document.getElementById('final-wpm').innerText = wpm;
                document.getElementById('final-acc').innerText = acc + '%';
                document.getElementById('final-miss').innerText = this.state.mistakes;
                document.getElementById('final-combo').innerText = this.state.maxCombo;

                let rank = "E";
                if (wpm > 20) rank = "D";
                if (wpm > 40) rank = "C";
                if (wpm > 60) rank = "B";
                if (wpm > 80) rank = "A";
                if (wpm > 100) rank = "S";
                if (wpm > 120) rank = "SS";
                
                const rankEl = document.getElementById('final-rank');
                rankEl.innerText = rank;
                rankEl.className = `text-5xl font-bold ${rank === 'SS' || rank === 'S' ? 'text-yellow-400 glow-text' : 'text-white'}`;
            }
        };

        // --- EVENTS ---
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                game.togglePause();
                return;
            }
            const key = e.key.toLowerCase();
            if (/^[a-z\-]$/.test(key)) {
                game.handleInput(key);
            }
        });

    </script>
</body>
</html>
